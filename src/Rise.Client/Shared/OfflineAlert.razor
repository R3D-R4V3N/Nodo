@implements IAsyncDisposable
@inject IJSRuntime JS

@if (!_isOnline)
{
    <div class="fixed top-4 left-1/2 z-50 flex w-[calc(100%-2rem)] max-w-xl -translate-x-1/2 items-start gap-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-900">
        <svg class="h-5 w-5 text-rose-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" focusable="false">
            <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zm.75 4.5a.75.75 0 10-1.5 0v5a.75.75 0 001.5 0v-5zm0 8a.75.75 0 10-1.5 0 .75.75 0 001.5 0z" clip-rule="evenodd" />
        </svg>
        <div class="flex-1">
            <p class="font-semibold">Je bent offline!</p>
            <p class="text-rose-700">Pagina's, HTML en Tailwind-styling worden vanuit de cache geladen tot je verbinding terug is.</p>
        </div>
    </div>
}

@code {
    private bool _isOnline = true;
    private IJSObjectReference? _module;
    private IJSObjectReference? _subscription;
    private DotNetObjectReference<OfflineAlert>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/offlineNotifier.js");
        _dotNetRef = DotNetObjectReference.Create(this);
        _subscription = await _module.InvokeAsync<IJSObjectReference>("registerStatusChanged", _dotNetRef);
    }

    [JSInvokable]
    public Task UpdateOnlineStatus(bool isOnline)
    {
        if (_isOnline == isOnline)
        {
            return Task.CompletedTask;
        }

        _isOnline = isOnline;
        return InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        if (_subscription is not null)
        {
            await _subscription.InvokeVoidAsync("dispose");
            await _subscription.DisposeAsync();
        }

        if (_module is not null)
        {
            await _module.DisposeAsync();
        }

        _dotNetRef?.Dispose();
    }
}