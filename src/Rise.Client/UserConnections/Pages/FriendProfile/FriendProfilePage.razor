@page "/FriendProfilePage/{id:guid}"
@layout EmptyLayout
@using Rise.Client.Profile.Models
@using Rise.Client.State
@using Rise.Client.UserConnections.Components.FriendProfile
@using Rise.Shared.Assets
@using Rise.Shared.Users
@using Rise.Shared.UserConnections
@inject NavigationManager NavigationManager

@if (user is null)
{
    <div class="flex justify-center items-center h-screen bg-[#F2F2F2] text-neutral-600">
        <LoadingIndicator Centered="true" Message="Profiel wordt geladen..." />
    </div>
}
else if (user?.User is null)
{
    <div class="flex justify-center items-center h-screen bg-[#F2F2F2] text-neutral-600">
        <p>Gebruiker niet gevonden.</p>
    </div>
}
else
{
    <div class="relative flex min-h-screen flex-col bg-[#F2F2F2] text-neutral-900 antialiased md:flex-row animate-fade-in overflow-y-hidden overflow-x-hidden">

        <div class="absolute top-[67%] left-1/2 z-[60] w-full max-w-[400px] -translate-x-1/2 -translate-y-1/2 block md:hidden ">
            <EmojiComponent Hobbies="@ProfileHobbies"/>
        </div>
        <BackButton/>

        <header class="relative h-[65vh] md:h-auto md:w-1/2 md:max-w-[550px]">
            <ProfileImageComponent ImgSource="@user.User.AvatarUrl"/>
            <BlurComponent/>

            <div class="absolute inset-x-0 bottom-9 flex flex-col justify-end p-5 ">
                <NameAndBadgesComponent Name="@user.User.Name"
                                        Age="@($"{CalculateAge(user.User.BirthDay)} jaar")"
                                        Gender="@user.User.Gender.ToString()"/>

            </div>
        </header>
            <DescriptionComponent PlusKnop="@(PageContext == UserConnectionTypeDto.AddFriends)"
                                  Description="@user.User.Biography"
                                  ProfileHobbies="@ProfileHobbies"/>

    </div>

}

@code {
    [Parameter] public Guid id { get; set; }

    [Inject] public UserState UserState { get; set; }

    [Inject] private IUserService UserService { get; set; } = default!;

    private UserResponse.CurrentUser? user;
    private UserConnectionTypeDto PageContext = UserConnectionTypeDto.Friend;

    private IReadOnlyList<ProfileHobbyModel> ProfileHobbies { get; set; } = Array.Empty<ProfileHobbyModel>();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"Ontvangen id: {id}");

        // ðŸ”¹ Haal querystring op en parse 'context' handmatig
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("context", out var contextValue))
        {
            if (Enum.TryParse<UserConnectionTypeDto>(contextValue, true, out var result))
            {
                PageContext = result;
            }
        }

        user = await UserService.GetUserAsync(id.ToString());

        if (user is null)
        {
            return;
        }

        var avatarUrl = user.User.AvatarUrl ?? DefaultImages.Profile;

        ProfileHobbies = new List<ProfileHobbyModel>
        {
            new ProfileHobbyModel("interest_fun", "Interesses", "ðŸŒŸ"),
            new ProfileHobbyModel("likes", "Ik hou van...", "â¤ï¸"),
            new ProfileHobbyModel("dislikes", "Ik hou niet van...", "ðŸš«"),
            new ProfileHobbyModel("hobbies", "Hobby's", "âš½")
        };

        var uriData = NavigationManager.Uri.Split('?');
        if (uriData.Length > 1)
        {
            var data = uriData[1].Replace("%22", "\"");
            data = System.Text.RegularExpressions.Regex.Unescape(data);

            var userConnectionType = System.Text.Json.JsonSerializer.Deserialize<UserConnectionTypeDto>(data);
            PageContext = userConnectionType;
        }
    }

    private static int CalculateAge(DateOnly birthDay)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var age = today.Year - birthDay.Year;

        if (today < birthDay.AddYears(age))
        {
            age--;
        }

        return age;
    }
}
