@using Rise.Shared.Common
@using Rise.Shared.Emergencies
@inject IEmergencyService EmergencyService
@inject NavigationManager NavigationManager
@using Serilog

<div class="col-span-2 bg-white rounded-xl p-4 ">
    <div class="flex justify-between items-center mb-4">
        <h3 class=" text-lg font-semibold">Noodknop meldingen</h3>
    </div>

    @if (_isLoading)
    {
        <p class="text-sm text-neutral-500">Aan het laden...</p>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <p class="text-sm text-red-600">@_errorMessage</p>
    }
    else if (_latestEmergencies.Count == 0)
    {
        <p class="text-sm text-neutral-500">Geen noodmeldingen gevonden.</p>
    }
    else
    {
        <div class="space-y-3">
            @foreach (var emergency in _latestEmergencies)
            {
                <div class="flex justify-between items-center gap-4">
                    <div>
                        <p class="font-normal">@emergency.Reporter</p>
                        <p class="text-sm text-neutral-500">@emergency.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <button class="inline-flex items-center justify-center gap-x-1.5 rounded-md bg-neutral-900 text-white px-3 py-2 text-sm font-semibold inset-ring-1 inset-ring-white/5 hover:bg-neutral-800 disabled:opacity-50 disabled:cursor-not-allowed" @onclick="() => ToggleDropdown(emergency.Id)" aria-expanded="@_openDropdowns.Contains(emergency.Id)" disabled="@_updatingEmergencies.Contains(emergency.Id)">
                                @EmergencyDto.TranslateStatusToText(emergency.Status)
                                <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="-mr-1 size-4 text-gray-300">
                                    <path d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" fill-rule="evenodd" />
                                </svg>
                            </button>

                            @if (_openDropdowns.Contains(emergency.Id))
                            {
                                <div class="absolute right-0 z-10 mt-2 w-52 origin-top-right rounded-md bg-gray-800 outline outline-1 -outline-offset-1 outline-white/10 shadow-lg transition transition-discrete data-[closed]:scale-95 data-[closed]:opacity-0">
                                    <div class="py-1">
                                        @foreach (var status in _statusOptions)
                                        {
                                            <button class="block w-full px-4 py-2 text-left text-sm text-gray-200 hover:bg-white/5 focus:bg-white/5 focus:outline-hidden" disabled="@_updatingEmergencies.Contains(emergency.Id)" @onclick="() => SelectStatusAsync(emergency, status)">
                                                @EmergencyDto.TranslateStatusToText(status)
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <button class="text-xs bg-neutral-100 text-neutral-800 px-3 py-1 rounded border" @onclick="() => NavigateToChat(emergency.ChatId)">Chat</button>
                        <span class="@GetStatusBadgeClass(emergency.Status)">@emergency.StatusLabel</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<EmergencyDto.Get> _latestEmergencies = [];
    private readonly EmergencyStatusDto[] _statusOptions = [EmergencyStatusDto.Open, EmergencyStatusDto.InProgress, EmergencyStatusDto.Closed];
    private bool _isLoading = true;
    private string? _errorMessage;
    private readonly HashSet<int> _updatingEmergencies = [];
    private readonly HashSet<int> _openDropdowns = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await EmergencyService.GetEmergenciesAsync(new QueryRequest.SkipTake
            {
                Skip = 0,
                Take = 3,
                SearchTerm = string.Empty
            });

            if (result.IsSuccess)
            {
                _latestEmergencies = result.Value.Emergencies
                    .OrderByDescending(e => e.CreatedAt)
                    .Take(3)
                    .ToList();
            }
            else
            {
                var errors = result.Errors
                    .DefaultIfEmpty(result.ValidationErrors.FirstOrDefault()?.ErrorMessage)
                    .Where(e => !string.IsNullOrWhiteSpace(e))
                    .ToList();

                _errorMessage = errors.Count > 0
                    ? string.Join(Environment.NewLine, errors)
                    : "Status kon niet worden aangepast.";
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Kon laatste noodmeldingen niet laden.");
            _errorMessage = "Fout bij het laden van noodmeldingen.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ToggleDropdown(int emergencyId)
    {
        if (_updatingEmergencies.Contains(emergencyId))
        {
            return;
        }

        if (!_openDropdowns.Add(emergencyId))
        {
            _openDropdowns.Remove(emergencyId);
        }
    }

    private void CloseDropdown(int emergencyId) => _openDropdowns.Remove(emergencyId);

    private async Task SelectStatusAsync(EmergencyDto.Get emergency, EmergencyStatusDto newStatus)
    {
        if (_updatingEmergencies.Contains(emergency.Id) || emergency.Status == newStatus)
        {
            CloseDropdown(emergency.Id);
            return;
        }

        await UpdateStatusAsync(emergency, newStatus);
    }

    private async Task UpdateStatusAsync(EmergencyDto.Get emergency, EmergencyStatusDto newStatus)
    {
        if (_updatingEmergencies.Contains(emergency.Id))
        {
            return;
        }

        _updatingEmergencies.Add(emergency.Id);
        _errorMessage = null;

        try
        {
            var result = await EmergencyService.UpdateStatusAsync(new EmergencyRequest.UpdateStatus
            {
                EmergencyId = emergency.Id,
                Status = newStatus
            });

            if (result.IsSuccess)
            {
                var updated = result.Value.Emergency;
                var index = _latestEmergencies.FindIndex(e => e.Id == updated.Id);

                if (index >= 0)
                {
                    _latestEmergencies[index] = updated;
                }
            }
            else
            {
                _errorMessage = string.Join(Environment.NewLine, result.Errors);
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Kon status van noodmelding niet bijwerken.");
            _errorMessage = "Fout bij het aanpassen van de status.";
        }
        finally
        {
            _updatingEmergencies.Remove(emergency.Id);
            CloseDropdown(emergency.Id);
            StateHasChanged();
        }
    }

    private void NavigateToChat(int chatId) => NavigationManager.NavigateTo($"/chat/{chatId}");

    private static string GetStatusBadgeClass(EmergencyStatusDto status) => status switch
    {
        EmergencyStatusDto.Closed => "text-xs bg-green-100 text-green-700 px-2 py-1 rounded",
        EmergencyStatusDto.InProgress => "text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded",
        _ => "text-xs bg-red-100 text-red-700 px-2 py-1 rounded",
    };
}
