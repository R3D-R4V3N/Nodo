@using Rise.Shared.Common
@using Rise.Shared.Emergencies
@inject IEmergencyService EmergencyService
@inject IToastService ToastService
@inject NavigationManager NavigationManager
@using Serilog

<div class="col-span-2 bg-white rounded-xl p-4 ">
    <div class="flex justify-between items-center mb-4">
        <h3 class=" text-lg font-semibold">Noodknop meldingen</h3>
    </div>

    @if (_isLoading)
    {
        <div class="loading-indicator text-sm text-neutral-500">
            <Spinner />
            <p class="loading-indicator__message">Noodmeldingen laden...</p>
        </div>
    }
    else if (_hasError)
    {
        <p class="text-sm text-neutral-500">Noodmeldingen zijn momenteel niet beschikbaar.</p>
    }
    else if (_latestEmergencies.Count == 0)
    {
        <p class="text-sm text-neutral-500">Geen noodmeldingen gevonden.</p>
    }
    else
    {
        <div class="space-y-3">
            @foreach (var emergency in _latestEmergencies)
            {
                <div class="flex justify-between items-center gap-4">
                    <div>
                        <p class="font-normal">@emergency.Reporter</p>
                        <p class="text-sm text-neutral-500">@emergency.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                    </div>

                    <div class="flex items-center gap-2">
                        <select class="text-sm border rounded px-2 py-1" value="@((int)emergency.Status)" disabled="@_updatingEmergencies.Contains(emergency.Id)" @onchange="args => UpdateStatusAsync(emergency, args)">
                            @foreach (var status in _statusOptions)
                            {
                                <option value="@((int)status)">@EmergencyDto.TranslateStatusToText(status)</option>
                            }
                        </select>
                        <button class="text-xs bg-neutral-100 text-neutral-800 px-3 py-1 rounded border" @onclick="() => NavigateToEmergency(emergency.Id)">Bekijk</button>
                        <span class="@GetStatusBadgeClass(emergency.Status)">@emergency.StatusLabel</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<EmergencyDto.GetEmergencies> _latestEmergencies = [];
    private readonly EmergencyStatusDto[] _statusOptions = [EmergencyStatusDto.Open, EmergencyStatusDto.Closed];
    private bool _isLoading = true;
    private bool _hasError;
    private readonly HashSet<int> _updatingEmergencies = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await EmergencyService.GetEmergenciesAsync(new QueryRequest.SkipTake
            {
                Skip = 0,
                Take = 3,
                SearchTerm = string.Empty
            });

            if (result.IsSuccess)
            {
                _latestEmergencies = result.Value.Emergencies
                    .OrderByDescending(e => e.CreatedAt)
                    .Take(3)
                    .ToList();
                _hasError = false;
            }
            else
            {
                var errors = result.Errors
                    .DefaultIfEmpty(result.ValidationErrors.FirstOrDefault()?.ErrorMessage)
                    .Where(e => !string.IsNullOrWhiteSpace(e))
                    .ToList();

                foreach (var error in errors)
                {
                    ToastService.ShowError(error!);
                }

                _hasError = true;
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Kon laatste noodmeldingen niet laden.");
            ToastService.ShowError("Fout bij het laden van noodmeldingen.");
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task UpdateStatusAsync(EmergencyDto.GetEmergencies emergency, ChangeEventArgs args)
    {
        if (args.Value is null || _updatingEmergencies.Contains(emergency.Id))
        {
            return;
        }

        if (!int.TryParse(args.Value.ToString(), out var statusValue))
        {
            return;
        }
        var selectedStatus = (EmergencyStatusDto)statusValue;
        _updatingEmergencies.Add(emergency.Id);

        try
        {
            var result = await EmergencyService.ResolveAsync(new EmergencyRequest.Resolve
            {
                EmergencyId = emergency.Id,
            });

            if (result.IsSuccess)
            {
                var updated = result.Value?.Emergency;
                var index = updated is null
                    ? -1
                    : _latestEmergencies.FindIndex(e => e.Id == updated.Id);

                if (index >= 0)
                {
                    if (updated is not null)
                    {
                        _latestEmergencies[index] = updated;
                    }

                    _latestEmergencies[index].Status = selectedStatus;
                }
                else
                {
                    // Fallback to ensure the UI reflects the chosen status even if the API
                    // response is missing or cannot be matched.
                    emergency.Status = selectedStatus;
                }
            }
            else
            {
                foreach (var error in result.Errors)
                {
                    ToastService.ShowError(error);
                }
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Kon status van noodmelding niet bijwerken.");
            ToastService.ShowError("Fout bij het aanpassen van de status.");
        }
        finally
        {
            _updatingEmergencies.Remove(emergency.Id);
            StateHasChanged();
        }
    }

    private void NavigateToEmergency(int emergencyId) => NavigationManager.NavigateTo($"/emergency/{emergencyId}");

    private static string GetStatusBadgeClass(EmergencyStatusDto status) => status switch
    {
        EmergencyStatusDto.Closed => "text-xs bg-green-100 text-green-700 px-2 py-1 rounded",
        _ => "text-xs bg-red-100 text-red-700 px-2 py-1 rounded",
    };
}
