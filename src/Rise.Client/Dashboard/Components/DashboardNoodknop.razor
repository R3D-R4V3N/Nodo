@using Rise.Shared.Common
@using Rise.Shared.Emergencies
@inject IEmergencyService EmergencyService
@using Serilog

<div class="col-span-2 bg-white rounded-xl p-4 ">
    <div class="flex justify-between items-center mb-4">
        <h3 class=" text-lg font-semibold">Noodknop meldingen</h3>

    </div>

    @if (_isLoading)
    {
        <p class="text-sm text-neutral-500">Aan het laden...</p>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <p class="text-sm text-red-600">@_errorMessage</p>
    }
    else if (_emergencies.Count == 0)
    {
        <p class="text-sm text-neutral-500">Geen noodmeldingen gevonden.</p>
    }
    else
    {
        <div class="space-y-3">
            @foreach (var emergency in _emergencies)
            {
                var status = GetStatus(emergency);
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-normal">@emergency.NotifierFullName</p>
                        <p class="text-sm text-neutral-500">@emergency.ReportedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <span class="@GetStatusBadgeClass(status)">@status</span>
                </div>
            }
        </div>
    }
</div>
@code {
    private List<EmergencyDto.Get> _emergencies = [];
    private bool _isLoading = true;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await EmergencyService.GetEmergenciesAsync(new QueryRequest.SkipTake
            {
                Take = 3,
                OrderBy = nameof(EmergencyDto.Get.ReportedAt),
                OrderDescending = true
            });

            if (result.IsSuccess)
            {
                _emergencies = result.Value.Emergencies
                    .OrderByDescending(e => e.ReportedAt)
                    .Take(3)
                    .ToList();
            }
            else
            {
                _errorMessage = string.Join(Environment.NewLine, result.Errors);
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Kon noodmeldingen niet laden.");
            _errorMessage = "Fout bij het laden van noodmeldingen.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static string GetStatus(EmergencyDto.Get emergency)
    {
        if (emergency.AllowedResolverCount > 0 && emergency.ResolvedCount >= emergency.AllowedResolverCount)
        {
            return "Voltooid";
        }

        if (emergency.ResolvedCount > 0)
        {
            return "In behandeling";
        }

        return "In afwachting";
    }

    private static string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Voltooid" => "text-xs bg-green-100 text-green-700 px-2 py-1 rounded",
            "In behandeling" => "text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded",
            "In afwachting" => "text-xs bg-red-100 text-red-700 px-2 py-1 rounded",
            _ => "text-xs bg-neutral-100 text-neutral-700 px-2 py-1 rounded"
        };
    }
}
