@page "/homepage"
@attribute [Authorize]
@using System.Security.Claims
@using Rise.Client.Chats
@using Rise.Shared.Chats
@layout MainLayout
@inject IChatService ChatService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<div class="min-h-screen bg-neutral-50 text-neutral-900 antialiased overflow-x-hidden">
  <!-- Header -->
  <header class="relative overflow-hidden bg-gradient-to-br from-emerald-600 via-emerald-600 to-emerald-700 text-white">
    <div class="pointer-events-none absolute inset-0 opacity-40">
      <div class="absolute -left-16 top-6 h-40 w-40 rounded-full bg-white/25 blur-3xl sm:-left-20 sm:top-10 sm:h-48 sm:w-48"></div>
      <div class="absolute bottom-0 right-[-4rem] h-48 w-48 rounded-full bg-emerald-400/40 blur-3xl sm:right-[-2rem] sm:h-64 sm:w-64"></div>
    </div>

    <div class="relative mx-auto max-w-screen-sm px-4 pb-16 pt-12 sm:px-6 sm:pb-20 sm:pt-16">
      <p class="text-sm font-medium text-white/75">Welkom terug</p>
      <h1 class="mt-1 text-3xl font-semibold leading-tight sm:text-4xl">
        Goeiemorgen @CurrentUser?.Name
      </h1>
      <p class="mt-2 text-sm text-white/80 sm:text-base">
        Vind je gesprekken sneller terug en start een nieuw praatje wanneer je wil.
      </p>

      <!-- Search -->
      <div class="mt-8 rounded-3xl bg-white/15 p-1.5 sm:p-2">
        <div class="flex items-center gap-3 rounded-3xl bg-white px-4 py-3 text-neutral-700 shadow-lg shadow-emerald-900/5 focus-within:ring-2 focus-within:ring-emerald-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400 sm:h-6 sm:w-6" fill="currentColor" viewBox="0 0 256 256">
            <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
          </svg>
          <input type="search"
                 placeholder="Zoek naar een gesprek"
                 class="flex-1 bg-transparent text-sm text-neutral-700 placeholder-neutral-400 outline-none sm:text-base"
                 @bind="_searchTerm"
                 @bind:event="oninput" />
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="relative mx-auto w-full max-w-screen-sm px-4 pb-24 sm:px-6">
    <section class="-mt-12 space-y-5 sm:-mt-16">
      <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-neutral-900 sm:text-xl">Jouw chats</h2>
          <p class="text-sm text-neutral-500">Blijf op de hoogte van je laatste gesprekken en updates.</p>
        </div>
        @if (!_isLoading && _chats.Count > 0)
        {
          <span class="text-xs font-medium uppercase tracking-wide text-neutral-400 sm:text-[13px]">@_chats.Count gesprekken</span>
        }
      </div>

      @if (_isLoading)
      {
        <div class="rounded-3xl border border-dashed border-neutral-200 bg-white/60 px-4 py-6 text-center text-sm text-neutral-500">
          Chats ladenâ€¦
        </div>
      }
      else if (!string.IsNullOrWhiteSpace(_loadError))
      {
        <div class="rounded-3xl border border-rose-200 bg-rose-50 px-4 py-6 text-center text-sm text-rose-600">
          @_loadError
        </div>
      }
      else if (_filteredChats.Count == 0)
      {
        <div class="rounded-3xl border border-neutral-200 bg-white px-4 py-8 text-center text-sm text-neutral-500">
          Er zijn nog geen chats.
        </div>
      }
      else
      {
        <!-- Chat list -->
        <ul class="space-y-3 sm:space-y-4">
          @foreach (var chat in _filteredChats)
          {
            <li>
              <button type="button"
                      class="group block w-full text-left"
                      @onclick="() => NavigateToChat(chat)">
                <article class="flex flex-col gap-3 rounded-3xl bg-white p-4 shadow-sm ring-1 ring-neutral-100 transition sm:flex-row sm:items-start sm:gap-4 sm:p-5 group-hover:shadow-md group-hover:ring-neutral-200 group-active:scale-[0.99]">
                  <!-- Avatar -->
                  <div class="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-emerald-100 to-emerald-200 text-sm font-semibold text-emerald-700 sm:h-14 sm:w-14">
                    @GetChatInitial(chat)
                  </div>

                  <!-- Texts -->
                  <div class="min-w-0 flex-1">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-baseline sm:justify-between">
                      <p class="text-base font-semibold text-neutral-900 sm:text-[17px] truncate">@GetChatTitle(chat)</p>
                      <time class="text-xs font-medium uppercase tracking-wide text-neutral-400 sm:text-[13px]">@GetLastActivity(chat)</time>
                    </div>
                    <p class="text-sm leading-snug text-neutral-500 sm:text-[15px]">
                      @GetLastMessagePreview(chat)
                    </p>
                  </div>
                </article>
              </button>
            </li>
          }
        </ul>
      }
    </section>
  </main>
</div>
