@page "/homepage"
@attribute [Authorize(Roles = $"{AppRoles.User}")]
@using Rise.Client.Chats
@using Rise.Shared.Assets
@using Rise.Shared.Chats
@using Microsoft.AspNetCore.SignalR.Client
@using Rise.Shared.Identity


@layout MainLayout
@inject IChatService ChatService
@inject NavigationManager NavigationManager


<div class="min-h-dvh bg-neutral-100 overflow-x-hidden">
  <!-- Header -->
  <TopBar UseHeaderElement="true" Class="shadow" InnerClass="px-4 sm:px-6 lg:px-8 py-8 sm:pb-7 space-y-4">
    <h1 class="text-2xl sm:text-3xl text-center lg:text-4xl font-semibold leading-tight">
      Goeiemorgen @UserState.User?.Name
    </h1>

    <!-- Search -->
    @* Search Component van maken, want re-use *@
    <div class="bg-white rounded-full flex items-center gap-2 px-4 py-3 sm:py-3.5 text-neutral-700 shadow">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 opacity-70" fill="currentColor" viewBox="0 0 256 256">
        <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
      </svg>
      <input type="search"
             placeholder="Zoek chat"
             class="ml-1 flex-1 bg-transparent outline-none text-sm sm:text-base placeholder-neutral-400"
             @bind="_searchTerm"
             @bind:event="oninput" />
    </div>
  </TopBar>

  <!-- Content -->
  <main class="mx-auto w-full max-w-screen-sm sm:max-w-screen-md lg:max-w-2xl px-4 sm:px-6 lg:px-8">
    <section class="mt-5 sm:mt-6">
      <div class="flex items-center justify-between mb-2 sm:mb-3 px-1">
        <h2 class="text-base sm:text-lg font-semibold text-neutral-700">Chats</h2>
        @if (!_isLoading && _chats.Count > 0)
        {
          <span class="text-xs sm:text-sm text-neutral-400">@_chats.Count gesprekken</span>
        }
      </div>

      @if (_isLoading)
      {
        <div class="px-1">
          <div class="loading-indicator">
            <Spinner />
            <p class="loading-indicator__message">Chats ladenâ€¦</p>
          </div>
        </div>
      }
      else if (!string.IsNullOrWhiteSpace(_loadError))
      {
        <p class="text-sm text-red-600 px-1">@_loadError</p>
      }
      else if (_filteredChats.Count == 0)
      {
        <p class="text-sm text-neutral-500 px-1">Er zijn nog geen chats.</p>
      }
      else
      {
        <!-- Chat list -->
        <ul class="space-y-3 sm:space-y-4 pb-8">
          @foreach (var chat in _filteredChats)
          {
            <li>
              <button type="button"
                      class="w-full text-left"
                      @onclick="() => NavigateToChat(chat)">
                <div class="relative bg-white rounded-3xl p-4 sm:p-5 shadow hover:shadow-md active:scale-[0.99] transition flex items-start gap-3 sm:gap-4">
                  <UnreadBadge Count="GetUnreadCount(chat.ChatId)" />
                  <!-- Avatar -->
                  @if (IsGroupChat(chat))
                  {
                    <img src="@DefaultImages.Group"
                         alt="Profielfoto"
                         class="h-12 w-12 sm:h-14 sm:w-14 rounded-full object-cover border border-neutral-200 bg-[#729788] shrink-0"/>
                  }
                  else
                  {
                    var otherUser = chat.Users.FirstOrDefault(u => u.Id != UserState.User.Id);
                    var isOnline = otherUser is not null && _onlineUsers.Contains(otherUser.AccountId);

                    <div class="relative inline-block">
                      <img src="@GetAvatarUrl(chat)"
                           alt="Profielfoto"
                           class="h-12 w-12 sm:h-14 sm:w-14 rounded-full object-cover border border-neutral-200 shrink-0 cursor-pointer hover:scale-105 transition"
                           @onclick="() => NavigateToFriendProfile(chat)" />

                      <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full border border-white
                        @(isOnline ? "bg-green-500" : "invisible")"></span>
                    </div>
                  }


                  <!-- Texts -->
                  <div class="min-w-0 flex-1">
                    <div class="flex items-baseline justify-between gap-2">
                      <p class="font-semibold text-[15px] sm:text-base truncate">@GetChatTitle(chat)</p>
                      <time class="text-[11px] sm:text-xs text-neutral-400 whitespace-nowrap">@GetLastActivity(chat)</time>
                    </div>
                    <p class="mt-0.5 text-xs sm:text-sm text-neutral-500 truncate">@GetLastMessagePreview(chat)</p>
                  </div>
                </div>
              </button>
            </li>
          }
        </ul>
      }
    </section>
  </main>
</div>
