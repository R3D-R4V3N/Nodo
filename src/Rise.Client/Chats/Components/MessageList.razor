@inject IJSRuntime JS

<section @ref="_scrollHost"
         class="flex-1 overflow-y-auto bg-neutral-100 px-4 py-5 space-y-2">
    @if (!string.IsNullOrWhiteSpace(TimestampText))
    {
        <p class="text-center text-[10px] sm:text-xs text-neutral-500">@TimestampText</p>
    }

    @for (var i = 0; i < Messages.Count; i++)
    {
        var message = Messages[i];
        var previous = i > 0 ? Messages[i - 1] : null;
        var isContinuation = ShouldGroupWithPrevious(message, previous);
        var isOutgoing = message.User.Id.Equals(UserState.User!.Id);
        var showSender = !isOutgoing
            && !string.IsNullOrWhiteSpace(message.User.Name)
            && !isContinuation;
        var avatarUrl = message.User.AvatarUrl;
        var hasAudio = !string.IsNullOrWhiteSpace(message.AudioDataBlob);

        <div class="@(isContinuation ? "space-y-0.5" : "space-y-1")">
            @if (showSender)
            {
                <p class="text-[10px] uppercase tracking-wide text-neutral-500">@message.User.Name</p>
            }

            @if (isOutgoing && hasAudio)
            {
                <OutgoingAudioBubble Text="@message.Content"
                                     AudioUrl="@message.AudioDataBlob!"
                                     AudioDuration="@message.AudioDuration"
                                     IsPending="@message.IsPending"
                                     OnCancelPending="() => HandleCancel(message)" />
            }
            else if (isOutgoing)
            {
                <OutgoingTextBubble Text="@message.Content"
                                    IsPending="@message.IsPending"
                                    OnCancelPending="() => HandleCancel(message)" />
            }
            else if (hasAudio)
            {
                <IncomingAudioBubble AudioUrl="@message.AudioDataBlob!"
                                     AudioDuration="@message.AudioDuration"
                                     Text="@message.Content"
                                     AvatarUrl="@avatarUrl" />
            }
            else
            {
                <IncomingTextBubble Text="@message.Content" AvatarUrl="@avatarUrl" />
            }
        </div>
    }
</section>
