@* Uitgaande audiobubbel *@
<div class="flex justify-end items-center gap-2">
    <div class="@BubbleClasses"
         role="@(CanCancelPending ? "button" : null)"
         @onclick="HandlePendingClick">
        <div class="flex flex-col gap-2 @(IsPending ? string.Empty : "text-white")">
            <audio class="w-52 max-w-full" controls src="@AudioUrl" preload="metadata"></audio>

            @if (DurationLabel is not null)
            {
                <span class="@DurationLabelClasses">@DurationLabel</span>
            }

            @if (!string.IsNullOrWhiteSpace(Text))
            {
                <p class="@AudioTextClasses">@Text</p>
            }
        </div>
    </div>

    @if (IsPending)
    {
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor"
             class="h-5 w-5 text-red-600" title="Wacht op verzending">
            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-8,56a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm8,104a12,12,0,1,1,12-12A12,12,0,0,1,128,184Z"></path>
        </svg>
    }
</div>

@code {
    [Parameter] public string? Text { get; set; }
    [Parameter] public string AudioUrl { get; set; } = string.Empty;
    [Parameter] public TimeSpan? AudioDuration { get; set; }
    [Parameter] public bool IsPending { get; set; }
    [Parameter] public EventCallback OnCancelPending { get; set; }

    private string BubbleClasses
    {
        get
        {
            var baseClasses = "shadow-sm text-sm max-w-[80%]";
            if (IsPending)
            {
                return $"py-3 {baseClasses} border-2 border-red-500 border-dashed focus:outline-none focus:ring-2 focus:ring-red-300{(CanCancelPending ? " cursor-pointer" : string.Empty)}";
            }

            return $"bg-[#127646] text-white rounded-2xl rounded-tr-none px-4 py-3 {baseClasses}";
        }
    }

    private string DurationLabelClasses => IsPending
        ? "text-[10px] uppercase tracking-wide text-neutral-600"
        : "text-[10px] uppercase tracking-wide text-white/70";

    private string AudioTextClasses => IsPending ? "text-sm text-neutral-900" : "text-sm text-white";

    private bool CanCancelPending => IsPending && OnCancelPending.HasDelegate;

    private string? DurationLabel => AudioDuration is { TotalSeconds: > 0 } duration
        ? duration.ToString(@"m\:ss")
        : null;

    private Task HandlePendingClick()
    {
        if (!CanCancelPending)
        {
            return Task.CompletedTask;
        }

        return OnCancelPending.InvokeAsync();
    }
}
