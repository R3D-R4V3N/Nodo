@using System
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using Rise.Shared.Assets
@using Rise.Shared.BlobStorage
@using Rise.Shared.Organizations
@using Rise.Shared.Users

<EditForm class="space-y-4" Model="Model" OnValidSubmit="OnSubmit">
    <FluentValidationValidator />

    <div class="relative w-full">
        <!-- Carousel wrapper -->
        <div class="relative overflow-hidden rounded-lg">
            <!-- Slide 1: basisgegevens + email -->
            <div class="@GetSlideClass(0)">
                <div class="grid gap-3 sm:grid-cols-2">
                    <div>
                        <label for="register-first-name" class="block text-sm font-medium text-[#04320C]">Voornaam</label>
                        <InputText id="register-first-name"
                                   @bind-Value="Model.FirstName"
                                   placeholder="Jouw voornaam"
                                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                        <ValidationMessage For="() => Model.FirstName" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>

                    <div>
                        <label for="register-last-name" class="block text-sm font-medium text-[#04320C]">Achternaam</label>
                        <InputText id="register-last-name"
                                   @bind-Value="Model.LastName"
                                   placeholder="Jouw achternaam"
                                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                        <ValidationMessage For="() => Model.LastName" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>
                </div>

                <div class="grid gap-3 sm:grid-cols-2 mt-4">
                    <div>
                        <label for="register-birth-date" class="block text-sm font-medium text-[#04320C]">Geboortedatum</label>
                        <InputDate id="register-birth-date"
                                   @bind-Value="Model.BirthDate"
                                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                        <ValidationMessage For="() => Model.BirthDate" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>

                    <div>
                        <label for="register-gender" class="block text-sm font-medium text-[#04320C]">Geslacht</label>
                        <InputSelect id="register-gender"
                                     @bind-Value="Model.Gender"
                                     class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1">
                            @foreach (var gender in Enum.GetValues<GenderTypeDto>())
                            {
                                <option value="@gender">@GetGenderLabel(gender)</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Model.Gender" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>
                </div>

                <!-- Email op slide 1 -->
                <div class="mt-4">
                    <label for="register-email" class="block text-sm font-medium text-[#04320C]">Email address</label>
                    <InputText id="register-email"
                               @bind-Value="Model.Email"
                               type="email"
                               placeholder="jouw@email.com"
                               class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                    <ValidationMessage For="() => Model.Email" class="mt-2 block text-sm font-medium text-red-600" />
                </div>
            </div>

            <!-- Slide 2: overige gegevens -->
            <div class="@GetSlideClass(1)">
                <div>
                    <label for="register-avatar" class="block text-sm font-medium text-[#04320C]">Profielfoto</label>
                    <div class="mt-2 flex items-center gap-4">
                        <img src="@AvatarPreview" alt="Voorbeeld profielfoto" class="h-16 w-16 rounded-full object-cover border border-neutral-200" />
                        <InputFile id="register-avatar" OnChange="OnAvatarChanged" accept="image/*" class="text-sm" />
                    </div>
                    <ValidationMessage For="() => Model.AvatarBlob" class="mt-2 block text-sm font-medium text-red-600" />
                </div>

                <div class="mt-4 flex space-x-3">
                    <div class="flex-1">
                        <label for="register-password" class="block text-sm font-medium text-[#04320C]">Wachtwoord</label>
                        <InputText id="register-password"
                                   @bind-Value="Model.Password"
                                   type="password"
                                   placeholder="••••••••"
                                   autocomplete="new-password"
                                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                        <ValidationMessage For="() => Model.Password" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>

                    <div class="flex-1">
                        <label for="register-confirm-password" class="block text-sm font-medium text-[#04320C]">Bevestig wachtwoord</label>
                        <InputText id="register-confirm-password"
                                   @bind-Value="Model.ConfirmPassword"
                                   type="password"
                                   placeholder="••••••••"
                                   autocomplete="new-password"
                                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
                        <ValidationMessage For="() => Model.ConfirmPassword" class="mt-2 block text-sm font-medium text-red-600" />
                    </div>
                </div>

                <div class="mt-4">
                    <label for="register-organization" class="block text-sm font-medium text-[#04320C]">Organisatie</label>
                    <select id="register-organization"
                            @bind="Model.OrganizationId"
                            class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1"
                            disabled="@(IsProcessing || Organizations.Count == 0)">
                        <option value="" disabled>Kies een organisatie</option>
                        @foreach (var organization in Organizations)
                        {
                            <option value="@organization.Id">@organization.Name</option>
                        }
                    </select>
                    @if (Organizations.Count == 0)
                    {
                        <p class="mt-2 text-sm text-red-600">Er zijn momenteel geen organisaties beschikbaar.</p>
                    }
                    <ValidationMessage For="() => Model.OrganizationId" class="mt-2 block text-sm font-medium text-red-600" />
                </div>
            </div>
        </div>

        <!-- Slider indicators -->
        <div class="mt-4 flex justify-center space-x-3">
            <button type="button"
                    class="w-3 h-3 rounded-full @(ActiveSlide == 0 ? "bg-[#0B6532]" : "bg-gray-300")"
                    aria-label="Slide 1"
                    aria-current="@(ActiveSlide == 0 ? "true" : "false")"
                    @onclick="() => GoToSlide(0)">
            </button>
            <button type="button"
                    class="w-3 h-3 rounded-full @(ActiveSlide == 1 ? "bg-[#0B6532]" : "bg-gray-300")"
                    aria-label="Slide 2"
                    aria-current="@(ActiveSlide == 1 ? "true" : "false")"
                    @onclick="() => GoToSlide(1)">
            </button>
        </div>

        <!-- Controls + submit -->
        <div class="mt-6 flex items-center justify-between">
            <button type="button"
                    id="previous-slide"
                    class="inline-flex items-center justify-center rounded-full border-2 border-[#0B6532] px-6 py-2 text-sm font-semibold text-[#0B6532] bg-white transition hover:bg-[#e8f5ec] disabled:opacity-50 disabled:cursor-not-allowed"
                    @onclick="PrevSlide"
                    disabled="@(ActiveSlide == 0)">
                Vorige
            </button>

            @if (ActiveSlide == 0)
            {
                <!-- Op slide 1: enkel Volgende -->
                <button type="button"
                        id="next-slide"
                        class="inline-flex items-center justify-center rounded-full bg-[#0B6532] px-6 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-[#0a572b]"
                        @onclick="NextSlide">
                    Volgende
                </button>
            }
        </div>

        @if (ActiveSlide == 1)
        {
            <!-- Op slide 2: grote, volle 'Registreer' knop -->
            <button type="submit"
                    class="mt-4 w-full rounded-full bg-[#0B6532] py-3 text-lg font-semibold text-white shadow-md transition hover:bg-[#0a572b] disabled:cursor-not-allowed disabled:bg-[#9fc9b3]"
                    disabled="@IsSubmitDisabled">
                @(IsProcessing ? "Aan het versturen..." : "Registreer")
            </button>
        }

        <div class="mt-4">
            <a href="/login" class="inline-flex w-full items-center justify-center rounded-full border-2 border-[#0B6532] py-3 text-lg font-semibold text-[#0B6532] bg-white transition hover:bg-[#e8f5ec]">
                Terug naar Login
            </a>
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public required AccountRequest.Register Model { get; set; }
    [Parameter] public EventCallback OnSubmit { get; set; }
    [Parameter] public IReadOnlyList<OrganizationDto.Summary> Organizations { get; set; } = [];
    [Parameter] public bool IsProcessing { get; set; }

    private int ActiveSlide { get; set; } = 0;

    private bool IsSubmitDisabled => IsProcessing
        || string.IsNullOrWhiteSpace(Model.FirstName)
        || string.IsNullOrWhiteSpace(Model.LastName)
        || string.IsNullOrWhiteSpace(Model.Email)
        || string.IsNullOrWhiteSpace(Model.Password)
        || string.IsNullOrWhiteSpace(Model.ConfirmPassword)
        || !string.Equals(Model.Password, Model.ConfirmPassword, StringComparison.Ordinal)
        || Model.OrganizationId is null or <= 0
        || Model.BirthDate is null
        || Model.AvatarBlob is null
        || Organizations.Count == 0;

    private string AvatarPreview => Model.AvatarBlob is null ? DefaultImages.Profile : Model.AvatarBlob.Base64Data;

    private async Task OnAvatarChanged(InputFileChangeEventArgs args)
    {
        var file = args.File;
        if (file is null) return;

        try
        {
            using var stream = file.OpenReadStream(MaxAvatarSize);
            using var memory = new MemoryStream();
            await stream.CopyToAsync(memory);
            var base64 = Convert.ToBase64String(memory.ToArray());
            var dataUrl = $"data:{file.ContentType};base64,{base64}";
            Model.AvatarBlob = new BlobDto.Create()
            {
                Name = file.Name,
                Base64Data = dataUrl
            };
        }
        catch
        {
            // ignore upload errors and keep previous selection
        }
    }

    private const long MaxAvatarSize = 300 * 1024;

    private static string GetGenderLabel(GenderTypeDto gender) => gender switch
    {
        GenderTypeDto.Man => "Man",
        GenderTypeDto.Woman => "Vrouw",
        _ => "X",
    };

    private string GetSlideClass(int index)
        => index == ActiveSlide ? "duration-700 ease-in-out" : "hidden duration-700 ease-in-out";

    private void GoToSlide(int index) => ActiveSlide = index;

    private void NextSlide()
    {
        if (ActiveSlide < 1) ActiveSlide++;
    }

    private void PrevSlide()
    {
        if (ActiveSlide > 0) ActiveSlide--;
    }
}