@page "/notification"
@attribute [Authorize]
@using Microsoft.JSInterop
@inject IJSRuntime JS

<PageTitle>Push notificaties</PageTitle>

<div class="flex flex-col gap-4">
    <TopBar Title="Push notificaties" ShowBackButton="true" />

    <div class="bg-white rounded-2xl shadow p-6 space-y-4">
        <div class="space-y-2">
            <h1 class="text-2xl font-bold text-gray-900">Web push demo</h1>
            <p class="text-sm text-gray-600">
                Vraag toestemming voor meldingen en verstuur een demo push-notificatie vanuit de PWA.
                Deze melding wordt door de service worker getoond zodat hij ook op het lockscreen zichtbaar is.
            </p>
        </div>

        <button class="w-full rounded-xl bg-[#127646] px-4 py-3 text-center text-white font-semibold shadow-sm transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed btn-click-anim"
                @onclick="SendNotification" disabled="@_isProcessing">
            @_buttonLabel
        </button>

        <p class="text-sm text-gray-700">@_statusMessage</p>
    </div>
</div>

@code {
    private bool _isProcessing;
    private string _statusMessage = "Nog niet geprobeerd.";
    private string _buttonLabel => _isProcessing ? "Bezig met verzenden..." : "Vraag toestemming en stuur notificatie";

    private async Task SendNotification()
    {
        _isProcessing = true;
        _statusMessage = "Notificatie wordt voorbereid...";
        StateHasChanged();

        try
        {
            var result = await JS.InvokeAsync<string>(
                "notifications.requestAndNotify",
                new
                {
                    title = "Nodo push demo",
                    body = "Zo ziet een web push melding eruit vanuit de PWA.",
                    data = new { url = "/" }
                });

            _statusMessage = result == "shown"
                ? "Notificatie verzonden via de service worker."
                : $"Toestemming status: {result}.";
        }
        catch (JSException ex)
        {
            _statusMessage = $"Kon notificatie niet tonen: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }
}
