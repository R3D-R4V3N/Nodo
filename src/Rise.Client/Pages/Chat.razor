@page "/chat"
@using Microsoft.AspNetCore.SignalR.Client
@using Rise.Client.Shared
@using Rise.Services
@inject WoordFilter Filter
@inject NavigationManager Nav
@layout ChatLayout
@implements IAsyncDisposable
<ChatHeader DisplayName="Helena"
            AvatarUrl="https://i.pravatar.cc/64?img=12"
            StatusText="Online 11 minuten geleden"
            OnBack="GoBack"
            OnAlert="TriggerAlert" />

<MessageList Messages="@_messages" TimestampText="Nov 30, 2023, 9:41 AM" />

<SuggestionChips Suggestions="@_suggestions" OnPick="InsertSuggestion" />

<ChatInput @bind-Value="_draft" OnSend="SendAsync" OnSendVoice="SendVoiceAsync" />

@code {
    private readonly List<Message> _messages = new();

    private readonly string[] _suggestions =
    [
        "Hey! Hoe gaat het vandaag?",
        "Wat heb je gedaan vandaag?",
        "Zullen we later bellen?",
        "Heb je plannen voor dit weekend?",
        "Ik ben trots op je! ðŸ’ª",
        "Wil je samen een spelletje spelen?"
    ];

    private HubConnection? _hubConnection;
    private const string CurrentUser = "Helena";
    private const string RemoteAvatarUrl = "https://i.pravatar.cc/64?img=12";
    private string _draft = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var hubUrl = new Uri(new Uri(Nav.BaseUri), "chathub");

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string, string>("ReceiveMessage", (user, message) =>
        {
            var isOutgoing = string.Equals(user, CurrentUser, StringComparison.OrdinalIgnoreCase);

            _messages.Add(new Message(Guid.NewGuid().ToString(), message, isOutgoing,
                isOutgoing ? null : RemoteAvatarUrl,
                DateTimeOffset.Now));

            InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<string, string, double>("ReceiveVoiceMessage", (user, dataUrl, durationSeconds) =>
        {
            var isOutgoing = string.Equals(user, CurrentUser, StringComparison.OrdinalIgnoreCase);
            TimeSpan? duration = double.IsFinite(durationSeconds) && durationSeconds > 0
                ? TimeSpan.FromSeconds(durationSeconds)
                : null;

            _messages.Add(new Message(Guid.NewGuid().ToString(), string.Empty, isOutgoing,
                isOutgoing ? null : RemoteAvatarUrl,
                DateTimeOffset.Now,
                dataUrl,
                duration));

            InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
    }

    private Task GoBack()
    {
        Nav.NavigateTo("/");
        return Task.CompletedTask;
    }

    private Task TriggerAlert()
    {
        Console.WriteLine("Alert clicked");
        return Task.CompletedTask;
    }

    private void InsertSuggestion(string text)
    {
        _draft = text;
        StateHasChanged();
    }

    private async Task SendAsync(string text)
    {
        if (_hubConnection is null || string.IsNullOrWhiteSpace(text))
        {
            return;
        }

        var censored = Filter.Censor(text);

        await _hubConnection.SendAsync("SendMessage", CurrentUser, censored);
        _draft = string.Empty;
    }

    private async Task SendVoiceAsync(RecordedAudio audio)
    {
        if (_hubConnection is null || string.IsNullOrWhiteSpace(audio.DataUrl))
        {
            return;
        }

        await _hubConnection.SendAsync("SendVoiceMessage", CurrentUser, audio.DataUrl, audio.DurationSeconds);
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
