@using System.Linq
@using Rise.Client.Profile.Models

<div class="@(IsOpen ? "fixed" : "hidden") inset-0 z-50" aria-hidden="@(IsOpen ? "false" : "true")">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-[1px]" role="presentation" @onclick="HandleClose"></div>

    <section class="absolute inset-x-0 bottom-0 max-h-[80vh] rounded-t-3xl bg-white shadow-2xl transition-transform duration-300 @(IsOpen ? "translate-y-0" : "translate-y-full")" role="dialog" aria-modal="true">
        <div class="flex justify-center pt-3">
            <div class="h-1.5 w-12 rounded-full bg-neutral-200"></div>
        </div>

        <div class="px-4 pt-2 pb-3 sm:px-6">
            <div class="flex items-center justify-between gap-3">
                <h2 class="text-lg font-semibold">Kies tot @MaxSelection gesprekssuggesties</h2>
                <button type="button" class="rounded-full p-2 text-neutral-500 hover:bg-neutral-100" @onclick="HandleClose" aria-label="Sluiten">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="mt-3">
                <label class="sr-only" for="suggestion-search">Zoek zin</label>
                <div class="flex items-center gap-2 rounded-2xl border border-neutral-200 bg-neutral-50 px-3 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l3.387 3.387a1 1 0 01-1.414 1.414l-3.387-3.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd" />
                    </svg>
                    <input id="suggestion-search" value="@SearchText" @oninput="HandleSearch" type="search" inputmode="search" autocomplete="off" placeholder="Zoek bv. Hoe gaat het?" class="w-full bg-transparent text-[15px] placeholder:text-neutral-400 focus:outline-none" />
                    @if (!string.IsNullOrWhiteSpace(SearchText))
                    {
                        <button type="button" class="text-sm text-neutral-500 hover:text-neutral-700" @onclick="ClearSearch">Wis</button>
                    }
                </div>
            </div>
        </div>

        <div class="px-4 pb-3 sm:px-6">
            <div class="space-y-2 overflow-y-auto overscroll-contain touch-scroll pb-24 max-h-[50vh] sm:max-h-[55vh] pt-1">
                @foreach (var option in FilteredOptions)
                {
                    var isSelected = IsSelected(option.Id);
                    var isLocked = !isSelected && SelectedCount >= MaxSelection;
                    <button type="button" class="w-full rounded-2xl border px-4 py-3 text-left text-sm font-medium shadow-sm focus:outline-none transition @GetOptionClasses(isSelected) disabled:opacity-40 disabled:cursor-not-allowed" role="option" aria-selected="@isSelected" disabled="@isLocked" @onclick="() => HandleToggle(option.Id)">
                        <div class="flex items-start gap-3">
                            <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full border @(isSelected ? "border-sky-500 bg-sky-500 text-white" : "border-neutral-300 text-transparent")">âœ“</span>
                            <span class="text-neutral-800">@option.Text</span>
                        </div>
                    </button>
                }
            </div>
        </div>

        <div class="pointer-events-auto sticky bottom-0 inset-x-0 bg-white/95 backdrop-blur px-4 py-3 sm:px-6 border-t">
            <div class="flex items-center justify-between">
                <p class="text-sm text-neutral-600">Geselecteerd: <span class="font-medium">@SelectedCount/@MaxSelection</span></p>
                <div class="flex items-center gap-2">
                    <button type="button" class="rounded-xl border border-sky-600 px-4 py-3 text-sm font-medium text-sky-700 hover:bg-sky-50" @onclick="HandleClear">Leegmaken</button>
                    <button type="button" class="rounded-xl bg-sky-600 px-4 py-3 text-sm font-medium text-white shadow hover:bg-sky-700 disabled:opacity-40 disabled:cursor-not-allowed" disabled="@(SelectedCount == 0)" @onclick="HandleConfirm">Bewaar</button>
                </div>
            </div>
        </div>
    </section>
</div>

@code {
    [Parameter] public IReadOnlyList<ChatSuggestionOption> Options { get; set; } = Array.Empty<ChatSuggestionOption>();
    [Parameter] public IReadOnlyCollection<string> Selection { get; set; } = Array.Empty<string>();
    [Parameter] public string SearchText { get; set; } = string.Empty;
    [Parameter] public int MaxSelection { get; set; }
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<string> OnToggle { get; set; }
    [Parameter] public EventCallback OnClear { get; set; }
    [Parameter] public EventCallback OnConfirm { get; set; }
    [Parameter] public EventCallback<string> SearchTextChanged { get; set; }

    private HashSet<string> _selectionLookup = new(StringComparer.OrdinalIgnoreCase);

    private IEnumerable<ChatSuggestionOption> FilteredOptions => string.IsNullOrWhiteSpace(SearchText)
        ? Options
        : Options.Where(option => option.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    private int SelectedCount => Selection.Count;

    protected override void OnParametersSet()
    {
        _selectionLookup = Selection is HashSet<string> set
            ? new HashSet<string>(set, StringComparer.OrdinalIgnoreCase)
            : Selection.ToHashSet(StringComparer.OrdinalIgnoreCase);
    }

    private bool IsSelected(string id) => _selectionLookup.Contains(id);

    private string GetOptionClasses(bool isSelected)
        => isSelected
            ? "border-sky-200 bg-sky-50"
            : "border-neutral-200 bg-white hover:border-sky-200 hover:bg-sky-50";

    private Task HandleClose() => OnClose.InvokeAsync();
    private Task HandleToggle(string id) => OnToggle.InvokeAsync(id);
    private Task HandleClear() => OnClear.InvokeAsync();
    private Task HandleConfirm() => OnConfirm.InvokeAsync();

    private Task HandleSearch(ChangeEventArgs args)
    {
        var value = args.Value?.ToString() ?? string.Empty;
        return SearchTextChanged.InvokeAsync(value);
    }

    private Task ClearSearch() => SearchTextChanged.InvokeAsync(string.Empty);
}
