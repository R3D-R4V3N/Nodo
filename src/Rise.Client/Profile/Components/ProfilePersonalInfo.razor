@using System
@using Microsoft.AspNetCore.Components
@using Rise.Shared.Users

<section class="mt-5 lg:mt-0">
    <h3 class="mb-2 text-sm font-medium text-neutral-700">Persoonlijke gegevens</h3>
    <div class="space-y-3 lg:grid lg:grid-cols-2 lg:gap-4 lg:space-y-0">
        <div class="rounded-2xl border border-neutral-200 bg-white px-3 py-2.5 lg:col-span-2">
            <label class="flex items-center gap-2 text-xs text-neutral-500" for="firstname-input">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path>
                </svg>
                Naam
            </label>
            @if (IsEditing)
            {
                <div class="mt-2 space-y-2 lg:grid lg:grid-cols-2 lg:gap-3 lg:space-y-0">
                    <input
                        id="firstname-input"
                        type="text"
                        class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
                        value="@FirstName"
                        @oninput="HandleFirstNameChanged"
                        autocomplete="name" />
                    <input
                        id="lastname-input"
                        type="text"
                        class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
                        value="@LastName"
                        @oninput="HandleLastNameChanged"
                        autocomplete="name" />
                </div>
            }
            else
            {
                <p class="mt-1 text-sm">@NameOrPlaceholder</p>
            }
        </div>

        <div class="rounded-2xl border border-neutral-200 bg-white px-3 py-2.5">
            <label class="flex items-center gap-2 text-xs text-neutral-500" for="email-input">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M224,48H32a8,8,0,0,0-8,8V192a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A8,8,0,0,0,224,48ZM203.43,64,128,133.15,52.57,64ZM216,192H40V74.19l82.59,75.71a8,8,0,0,0,10.82,0L216,74.19V192Z"></path>
                </svg>
                E-mail
            </label>
            @if (IsEditing)
            {
                <input
                    id="email-input"
                    type="email"
                    class="w-full rounded-lg border border-neutral-200 bg-white mt-2 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
                    value="@Email"
                    @oninput="HandleEmailChanged"
                    autocomplete="email" />
            }
            else
            {
                <p class="mt-1 text-sm">@EmailOrPlaceholder</p>
            }
        </div>

        <div class="rounded-2xl border border-neutral-200 bg-white px-3 py-2.5 lg:col-span-2">
            <label class="flex items-center gap-2 text-xs text-neutral-500" for="bio-input">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M216,48H40A16,16,0,0,0,24,64V224a15.84,15.84,0,0,0,9.25,14.5A16.05,16.05,0,0,0,40,240a15.89,15.89,0,0,0,10.25-3.78l.09-.07L83,208H216a16,16,0,0,0,16-16V64A16,16,0,0,0,216,48ZM40,224h0ZM216,192H80a8,8,0,0,0-5.23,1.95L40,224V64H216Z"></path>
                </svg>
                Bio
            </label>
            @if (IsEditing)
            {
                <div class="mt-2">
                    <textarea
                        id="bio-input"
                        class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
                        rows="4"
                        maxlength="240"
                        placeholder="Schrijf een korte bio (max. 240 tekens)"
                        @oninput="HandleBioChanged">@_bio</textarea>
                    <div class="mt-1 text-xs text-neutral-500">@BioLength/240</div>
                </div>
            }
            else
            {
                <p class="mt-1 text-sm whitespace-pre-wrap break-words hyphens-auto max-w-full">@BioOrPlaceholder</p>
            }
        </div>

        <div class="rounded-2xl border border-neutral-200 bg-white px-3 py-2.5">
            <label class="flex items-center gap-2 text-xs text-neutral-500" for="gender-select">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M208,24H168a8,8,0,0,0,0,16h20.69L163.54,65.15A64,64,0,1,0,112,175.48V192H88a8,8,0,0,0,0,16h24v24a8,8,0,0,0,16,0V208h24a8,8,0,0,0,0-16H128V175.48a63.92,63.92,0,0,0,45.84-98L200,51.31V72a8,8,0,0,0,16,0V32A8,8,0,0,0,208,24ZM120,160a48,48,0,1,1,48-48A48.05,48.05,0,0,1,120,160Z"></path>
                </svg>
                Geslacht
            </label>
            @if (IsEditing)
            {
                <select
                    id="gender-select"
                    class="w-full rounded-lg border border-neutral-200 bg-white mt-2 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-600"
                    value="@Gender"
                    @onchange="HandleGenderChanged">
                    @foreach (var gender in Enum.GetValues<GenderTypeDto>())
                    {
                        <option value="@gender">@GenderDisplay(gender)</option>
                    }
                </select>
            }
            else
            {
                <p class="mt-1 text-sm">@GenderDisplay(Gender)</p>
            }
        </div>
    </div>
</section>

@code {
    private string _firstName = string.Empty;
    private string _lastName = string.Empty;
    private string _email = string.Empty;
    private string _bio = string.Empty;

    [Parameter]
    public string FirstName
    {
        get => _firstName;
        set => _firstName = value ?? string.Empty;
    }

    [Parameter] public EventCallback<string> FirstNameChanged { get; set; }

    [Parameter]
    public string LastName
    {
        get => _lastName;
        set => _lastName = value ?? string.Empty;
    }

    [Parameter] public EventCallback<string> LastNameChanged { get; set; }

    [Parameter]
    public string Email
    {
        get => _email;
        set => _email = value ?? string.Empty;
    }

    [Parameter] public EventCallback<string> EmailChanged { get; set; }

    [Parameter]
    public string Bio
    {
        get => _bio;
        set => _bio = value ?? string.Empty;
    }

    [Parameter] public EventCallback<string> BioChanged { get; set; }

    [Parameter]
    public GenderTypeDto Gender { get; set; }

    [Parameter] public EventCallback<GenderTypeDto> GenderChanged { get; set; }
    [Parameter] public bool IsEditing { get; set; }

    private string NameOrPlaceholder => string.IsNullOrWhiteSpace(FirstName) ? "–" : $"{FirstName} {LastName}";
    private string EmailOrPlaceholder => string.IsNullOrWhiteSpace(Email) ? "–" : Email;
    private string BioOrPlaceholder => string.IsNullOrWhiteSpace(Bio) ? "–" : Bio;
    private int BioLength => Bio?.Length ?? 0;

    private string GenderDisplay(GenderTypeDto gender) => gender switch
    {
        GenderTypeDto.Man   => "Man",
        GenderTypeDto.Woman => "Vrouw",
        GenderTypeDto.X     => "X",
        _ => "X"
    };

    private async Task HandleFirstNameChanged(ChangeEventArgs args)
    {
        var newValue = args.Value?.ToString() ?? string.Empty;
        if (string.Equals(newValue, _firstName, StringComparison.Ordinal))
        {
            return;
        }

        _firstName = newValue;
        if (FirstNameChanged.HasDelegate)
        {
            await FirstNameChanged.InvokeAsync(newValue);
        }
    }

    private async Task HandleLastNameChanged(ChangeEventArgs args)
    {
        var newValue = args.Value?.ToString() ?? string.Empty;
        if (string.Equals(newValue, _lastName, StringComparison.Ordinal))
        {
            return;
        }

        _lastName = newValue;
        if (LastNameChanged.HasDelegate)
        {
            await LastNameChanged.InvokeAsync(newValue);
        }
    }

    private async Task HandleEmailChanged(ChangeEventArgs args)
    {
        var newValue = args.Value?.ToString() ?? string.Empty;
        if (string.Equals(newValue, _email, StringComparison.Ordinal))
        {
            return;
        }

        _email = newValue;
        if (EmailChanged.HasDelegate)
        {
            await EmailChanged.InvokeAsync(newValue);
        }
    }

    private async Task HandleBioChanged(ChangeEventArgs args)
    {
        var newValue = args.Value?.ToString() ?? string.Empty;
        if (string.Equals(newValue, _bio, StringComparison.Ordinal))
        {
            return;
        }

        _bio = newValue;
        if (BioChanged.HasDelegate)
        {
            await BioChanged.InvokeAsync(newValue);
        }
    }

    private async Task HandleGenderChanged(ChangeEventArgs args)
    {
        Enum.TryParse(args.Value?.ToString() ?? string.Empty, out GenderTypeDto gender);

        Gender = gender;

        if (GenderChanged.HasDelegate)
        {
            await GenderChanged.InvokeAsync(gender);
        }
    }
}
