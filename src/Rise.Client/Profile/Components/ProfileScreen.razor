@using Microsoft.AspNetCore.Authorization
@using Rise.Client.Profile.Models
@attribute [Authorize]

<div class="min-h-screen bg-neutral-50 text-neutral-900 antialiased overflow-x-hidden">
    <ProfileHeader
        Title="Profiel"
        IsEditing="@IsEditing"
        CanEdit="@(!IsLoading && !HasError)"
        OnBack="NavigateBack"
        OnEdit="BeginEdit"
        OnCancel="CancelEdit"
        OnSave="SaveEdit" />

    @if (IsLoading)
    {
        <main class="mx-auto max-w-screen-sm px-4 pb-24 pt-6">
            <div class="rounded-2xl border border-dashed border-neutral-300 bg-white/60 px-4 py-8 text-center">
                <div class="loading-indicator loading-indicator--centered justify-center">
                    <Spinner />
                    <p class="loading-indicator__message">Profiel wordt geladen...</p>
                </div>
            </div>
        </main>
    }
    else if (HasError)
    {
        <main class="mx-auto max-w-screen-sm px-4 pb-24 pt-6">
            <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-6 text-center text-sm text-rose-700">
                @ErrorMessage
            </div>
        </main>
    }
    else
    {
        <main class="mx-auto max-w-screen-sm px-4 pb-24 pt-6">
            <section class="text-center">
                <ProfileAvatar
                    AvatarUrl="@_draft.AvatarUrl"
                    DisplayName="@DisplayName"
                    MemberSince="@_model.MemberSince"
                    OnAvatarChanged="OnAvatarChanged" />
            </section>

            <ProfilePersonalInfo
                @bind-FirstName="_draft.FirstName"
                @bind-LastName="_draft.LastName"
                @bind-Email="_draft.Email"
                @bind-Bio="_draft.Bio"
                @bind-Gender="_draft.Gender"
                BirthDay="@BirthDayDisplay"
                IsEditing="@IsEditing" />

            <ProfileInterestsSection
                Likes="@LikeChips"
                Dislikes="@DislikeChips"
                Hobbies="@Hobbies"
                DefaultChatLines="@ChatLineChips"
                IsEditing="@IsEditing"
                MaxLikes="@MaxLikes"
                MaxDislikes="@MaxDislikes"
                MaxHobbies="@MaxHobbies"
                MaxChatLines="@MaxChatLines"
                OnManageLikes="OpenLikesPicker"
                OnManageDislikes="OpenDislikesPicker"
                OnManageHobbies="OpenHobbiesPicker"
                OnManageChatLines="OpenChatLinesPicker"
                OnRemoveLike="RemoveLike"
                OnRemoveDislike="RemoveDislike"
                OnRemoveHobby="RemoveHobby"
                OnRemoveChatLine="RemoveChatLine" />

            <section class="mt-8">
                <div class="rounded-2xl border border-neutral-200 bg-white p-5 shadow-sm">
                    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                        <div class="space-y-1">
                            <h2 class="text-lg font-semibold text-neutral-900">Pushmeldingen</h2>
                            <p class="text-sm text-neutral-600">
                                Ontvang een melding bij nieuwe chatberichten, zelfs wanneer je de app gesloten hebt.
                            </p>
                            @if (!string.IsNullOrWhiteSpace(PushStatusMessage))
                            {
                                <p class="text-sm @(IsPushStatusError ? "text-rose-600" : "text-emerald-700")">@PushStatusMessage</p>
                            }
                        </div>

                        <button class="inline-flex items-center justify-center gap-2 rounded-xl bg-[#127646] px-4 py-3 text-sm font-semibold text-white shadow hover:bg-[#0f6a3f] active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60"
                                @onclick="EnablePushNotifications"
                                disabled="@(!CanRequestPush || IsSubscribingToPush)">
                            @if (IsSubscribingToPush)
                            {
                                <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                                </svg>
                                <span>Bezig met inschakelen...</span>
                            }
                            else
                            {
                                <span>Pushmeldingen inschakelen</span>
                            }
                        </button>
                    </div>
                </div>
            </section>
        </main>
    }

    <ProfileInterestsPicker
        Interests="@HobbyOptions"
        Selection="@PickerSelection"
        SearchText="@PickerSearch"
        MaxSelection="@MaxHobbies"
        IsOpen="@IsPickerOpen"
        OnToggle="TogglePickerSelection"
        OnClear="ClearPickerSelection"
        OnConfirm="ConfirmPickerSelection"
        OnClose="ClosePicker"
        SearchTextChanged="UpdatePickerSearch" />

    <ProfilePreferencesPicker
        Title="@PreferencePickerTitle"
        SearchPlaceholder="@PreferencePickerPlaceholder"
        Options="@PreferenceOptions"
        Selection="@PreferencePickerSelection"
        SearchText="@PreferencePickerSearch"
        MaxSelection="@MaxPreferences"
        IsOpen="@IsPreferencePickerOpen"
        UseDislikeTheme="@IsDislikePicker"
        OnToggle="TogglePreferencePickerSelection"
        OnClear="ClearPreferencePickerSelection"
        OnConfirm="ConfirmPreferencePickerSelection"
        OnClose="ClosePreferencePicker"
        SearchTextChanged="UpdatePreferencePickerSearch" />

    <ProfilePreferencesPicker
        Title="Kies je favoriete chatzinnen"
        SearchPlaceholder="Zoek een zin…"
        Options="@ChatLineOptions"
        Selection="@ChatLinePickerSelection"
        SearchText="@ChatLinePickerSearch"
        MaxSelection="@MaxChatLines"
        UseSingleColumnLayout="true"
        IsOpen="@IsChatLinePickerOpen"
        OnToggle="ToggleChatLinePickerSelection"
        OnClear="ClearChatLinePickerSelection"
        OnConfirm="ConfirmChatLinePickerSelection"
        OnClose="CloseChatLinePicker"
        SearchTextChanged="UpdateChatLinePickerSearch"
        AllowCustomEntry="true"
        CustomEntryLabel="Voeg je eigen zin toe"
        CustomEntryPlaceholder="Typ een eigen zin…"
        CustomEntryValue="@NewChatLineText"
        CustomEntryValueChanged="UpdateNewChatLineText"
        OnCreateCustomEntry="AddCustomChatLineAsync"
        CustomEntryError="@NewChatLineError"
        IsCustomEntryBusy="@IsAddingCustomChatLine"
        IsCustomEntryDisabled="@IsCustomChatLineLimitReached"
        CustomEntryMaxLength="@CustomChatLineMaxLength" />
</div>
