@using System.Net.Http.Json
@using System.Security.Claims
@using Rise.Shared.Notifications
@inject IJSRuntime Js
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.Toast.Services.IToastService ToastService

<label for="hs-push-toggle" class="relative inline-block w-11 h-6 cursor-pointer">
    <input type="checkbox"
           id="hs-push-toggle"
           class="sr-only"
           checked="@_isPushEnabled"
           @onchange="OnToggleChanged"
           disabled="@_isBusy" />

    <!-- Achtergrond -->
    <span class="@GetTrackClasses()"></span>

    <!-- Knop -->
    <span class="@GetThumbClasses()"></span>
</label>

@code {
    private bool _isBusy;
    private bool _isPushEnabled;  // status van de toggle

    private const string VapidPublicKey = "BM0rBfX8utfLUxaLyIZyYKUfly2TPfrCe68hotJxY63aOmRMa5ic9_TwH4izyyTd3swnA2bC-cGzuXjItveRr6Y";
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _isBusy = true;
        StateHasChanged();

        try
        {
            _isPushEnabled = await Js.InvokeAsync<bool>("nodoPush.hasActiveSubscription");
        }
        catch
        {
            _isPushEnabled = false;
        }
        finally
        {
            _isBusy = false;
            StateHasChanged();
        }
    }

    // ---------- UI helpers ----------
    private string GetTrackClasses()
    {
        var baseClasses = "absolute inset-0 rounded-full transition-colors duration-200";
        var stateClass = _isPushEnabled ? "bg-[#127646]" : "bg-gray-300";
        var busyClass = _isBusy ? "opacity-50" : "";
        return $"{baseClasses} {stateClass} {busyClass}";
    }

    private string GetThumbClasses()
    {
        var baseClasses = "absolute top-1/2 left-0.5 -translate-y-1/2 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200";
        var moveClass = _isPushEnabled ? "translate-x-5" : "";
        return $"{baseClasses} {moveClass}";
    }

    // ---------- Event ----------
    private async Task OnToggleChanged(ChangeEventArgs e)
    {
        var isChecked = false;

        if (e.Value is bool b)
        {
            isChecked = b;
        }
        else if (bool.TryParse(e.Value?.ToString(), out var parsed))
        {
            isChecked = parsed;
        }

        if (isChecked)
        {
            var success = await EnablePushAsync();
            _isPushEnabled = success; // als het mislukt springt de toggle terug
        }
        else
        {
            _isPushEnabled = false;
            ToastService.ShowInfo("Pushnotificaties zijn uitgeschakeld (client-side).");
        }

        StateHasChanged();
    }

    // ---------- Push logica ----------
    private async Task<bool> EnablePushAsync()
    {
        _isBusy = true;
        StateHasChanged();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity is null || !user.Identity.IsAuthenticated)
            {
                ToastService.ShowError("Je moet ingelogd zijn om notificaties in te schakelen.");
                return false;
            }

            var userId =
                user.FindFirst("sub")?.Value ??
                user.FindFirst(ClaimTypes.NameIdentifier)?.Value ??
                user.Identity.Name;

            if (string.IsNullOrWhiteSpace(userId))
            {
                ToastService.ShowError("Kon je user-id niet bepalen.");
                return false;
            }

            var subscription = await Js.InvokeAsync<PushSubscriptionDto>(
                "nodoPush.requestPushSubscription",
                VapidPublicKey);

            if (subscription is null)
            {
                ToastService.ShowError("Kon geen subscription verkrijgen van de browser.");
                return false;
            }

            subscription.UserId = userId;

            var client = HttpClientFactory.CreateClient("SecureApi");
            var response = await client.PostAsJsonAsync("api/push/subscribe", subscription);

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess("Pushnotificaties zijn ingeschakeld.");
                return true;
            }
            else
            {
                ToastService.ShowError($"Fout bij opslaan van subscription: {response.StatusCode}");
                return false;
            }
        }
        catch (JSException jsEx)
        {
            ToastService.ShowError($"Browserfout: {jsEx.Message}");
            return false;
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Onverwachte fout: {ex.Message}");
            return false;
        }
        finally
        {
            _isBusy = false;
            StateHasChanged();
        }
    }
}
