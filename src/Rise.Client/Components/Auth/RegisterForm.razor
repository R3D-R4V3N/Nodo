@using System
@using System.Linq
@using Rise.Shared.Organizations

<EditForm class="space-y-4" Model="Model" OnValidSubmit="HandleValidSubmit">
    <FluentValidationValidator />

    <div>
        <label for="register-name" class="block text-sm font-medium text-[#04320C]">Volledige naam</label>
        <InputText id="register-name"
                   @bind-Value="FullName"
                   @bind-Value:event="oninput"
                   placeholder="Jouw naam"
                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
        <ValidationMessage For="() => Model.FirstName" class="mt-2 block text-sm font-medium text-red-600" />
    </div>

    <div>
        <label for="register-email" class="block text-sm font-medium text-[#04320C]">Email address</label>
        <InputText id="register-email"
                   @bind-Value="Model.Email"
                   type="email"
                   placeholder="jouw@email.com"
                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
        <ValidationMessage For="() => Model.Email" class="mt-2 block text-sm font-medium text-red-600" />
    </div>

    <div>
        <label for="register-password" class="block text-sm font-medium text-[#04320C]">Wachtwoord</label>
        <InputText id="register-password"
                   @bind-Value="Model.Password"
                   type="password"
                   placeholder="••••••••"
                   autocomplete="new-password"
                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
        <ValidationMessage For="() => Model.Password" class="mt-2 block text-sm font-medium text-red-600" />
    </div>

    <div>
        <label for="register-confirm-password" class="block text-sm font-medium text-[#04320C]">Bevestig wachtwoord</label>
        <InputText id="register-confirm-password"
                   @bind-Value="Model.ConfirmPassword"
                   type="password"
                   placeholder="••••••••"
                   autocomplete="new-password"
                   class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1" />
        <ValidationMessage For="() => Model.ConfirmPassword" class="mt-2 block text-sm font-medium text-red-600" />
    </div>

    <div>
        <label for="register-organization" class="block text-sm font-medium text-[#04320C]">Organisatie</label>
        <InputSelect id="register-organization"
                     @bind-Value="Model.OrganizationId"
                     class="mt-2 block w-full rounded-full bg-white px-4 py-3 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0B6532] focus:ring-offset-1">
            <option value="0" disabled>Maak een keuze</option>
            @foreach (var organization in Organizations)
            {
                <option value="@organization.Id">@organization.Name</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Model.OrganizationId" class="mt-2 block text-sm font-medium text-red-600" />
    </div>

    <button type="submit" class="w-full rounded-full bg-[#0B6532] py-3 text-lg font-semibold text-white shadow-md transition hover:bg-[#0a572b]" disabled="@(!Organizations.Any() || Model.OrganizationId == 0)">
        Registreer
    </button>

    <a href="/login" class="inline-flex w-full items-center justify-center rounded-full border-2 border-[#0B6532] py-3 text-lg font-semibold text-[#0B6532] bg-white transition hover:bg-[#e8f5ec]">
        Terug naar Login
    </a>
</EditForm>

@code {
    [Parameter]
    public required AccountRequest.Register Model { get; set; }

    [Parameter]
    public EventCallback OnSubmit { get; set; }

    [Parameter]
    public IEnumerable<OrganizationDto.Index> Organizations { get; set; } = Array.Empty<OrganizationDto.Index>();

    private string fullName = string.Empty;

    private string FullName
    {
        get => fullName;
        set
        {
            fullName = value;
            (Model.FirstName, Model.LastName) = SplitFullName(fullName);
        }
    }

    private async Task HandleValidSubmit()
    {
        await OnSubmit.InvokeAsync();
    }

    private static (string FirstName, string LastName) SplitFullName(string fullName)
    {
        var cleaned = fullName?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(cleaned))
        {
            return (string.Empty, string.Empty);
        }

        var parts = cleaned.Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
        {
            return (parts[0], parts[0]);
        }

        return (parts[0], parts[1]);
    }
}
